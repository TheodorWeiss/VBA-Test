Public Sub FilterPivot_Artikelnummer_FromTable()
    ' Applies an OLAP filter on Artikelnummer using UniqueNames of PivotItems (safe for OLAP).
    ' Reads desired Artikelnummer values from tbl_Artikel[Artikelnummer] (captions), then maps to PivotItem.Name.

    Dim pt As PivotTable
    Dim cf As CubeField
    Dim pf As PivotField

    Dim lo As ListObject
    Dim lc As ListColumn
    Dim dictWanted As Object

    Dim r As Range
    Dim pi As PivotItem

    Dim arr() As Variant
    Dim cnt As Long
    Dim captionKey As String

    On Error GoTo ErrHandler

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual

    ' 1) Get PivotTable
    Set pt = GetPivotTableSafe()
    If pt Is Nothing Then Err.Raise vbObjectError + 1, , "No PivotTable found. Click inside the PivotTable first."
    If Not pt.PivotCache.OLAP Then Err.Raise vbObjectError + 2, , "PivotTable is not OLAP."

    ' 2) Get input table and column
    Set lo = FindListObject("tbl_Artikel")
    If lo Is Nothing Then Err.Raise vbObjectError + 3, , "ListObject 'tbl_Artikel' not found."

    Set lc = lo.ListColumns("Artikelnummer")
    If lc Is Nothing Then Err.Raise vbObjectError + 4, , "Column 'Artikelnummer' not found in tbl_Artikel."
    If lc.DataBodyRange Is Nothing Then Err.Raise vbObjectError + 5, , "tbl_Artikel[Artikelnummer] has no rows."

    ' 3) Load wanted captions into dictionary
    Set dictWanted = CreateObject("Scripting.Dictionary")
    dictWanted.CompareMode = 1 ' TextCompare

    For Each r In lc.DataBodyRange.Cells
        captionKey = Trim$(CStr(r.Value))
        If Len(captionKey) > 0 Then dictWanted(captionKey) = True
    Next r

    If dictWanted.Count = 0 Then Err.Raise vbObjectError + 6, , "No values in tbl_Artikel[Artikelnummer]."

    ' 4) Find CubeField containing Artikelnummer
    Set cf = Nothing
    For Each cf In pt.CubeFields
        If InStr(1, cf.Name, "Artikelnummer", vbTextCompare) > 0 Then Exit For
    Next cf
    If cf Is Nothing Then Err.Raise vbObjectError + 7, , "CubeField containing 'Artikelnummer' not found."
    If cf.PivotFields.Count = 0 Then Err.Raise vbObjectError + 8, , "CubeField has no PivotFields."

    Set pf = cf.PivotFields(1)

    ' 5) Build list of UniqueNames (PivotItem.Name) for items whose Caption is in our wanted list
    cnt = 0
    For Each pi In pf.PivotItems
        captionKey = Trim$(CStr(pi.Caption))
        If dictWanted.Exists(captionKey) Then
            cnt = cnt + 1
            ReDim Preserve arr(1 To cnt)
            arr(cnt) = pi.Name ' IMPORTANT: OLAP UniqueName, not the caption
        End If
    Next pi

    If cnt = 0 Then
        Err.Raise vbObjectError + 9, , "No matches found. Likely caption mismatch (e.g., leading zeros)."
    End If

    ' 6) Apply filter
    On Error Resume Next
    pf.ClearAllFilters
    On Error GoTo ErrHandler

    pf.VisibleItemsList = arr
    pt.RefreshTable

    MsgBox "Filter applied using OLAP UniqueNames. Selected items: " & cnt & " (from list: " & dictWanted.Count & ")", vbInformation

Cleanup:
    Application.ScreenUpdating = True
    Application.EnableEvents = True
    Application.Calculation = xlCalculationAutomatic
    Exit Sub

ErrHandler:
    MsgBox "Error " & Err.Number & ": " & Err.Description, vbExclamation
    Resume Cleanup
End Sub
