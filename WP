Option Explicit

Public Sub FilterPivot_Artikelnummer_FromTable()
    ' Filters the PivotTable field "Artikelnummer" based on values from Excel table tbl_Artikel[Artikelnummer].
    ' Works for both OLAP and non-OLAP PivotTables.

    Dim pt As PivotTable
    Dim pf As PivotField
    Dim lo As ListObject
    Dim wsList As Worksheet
    Dim dict As Object
    Dim r As Range
    Dim key As String

    Dim pi As PivotItem
    Dim arr() As Variant
    Dim cnt As Long
    Dim isOlap As Boolean

    On Error GoTo ErrHandler

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual

    ' 1) Get the PivotTable safely:
    '    - First try ActiveCell.PivotTable
    '    - If that fails, take the first PivotTable on the active sheet
    Set pt = GetPivotTableSafe()
    If pt Is Nothing Then
        MsgBox "No PivotTable found. Click inside the PivotTable and run the macro again.", vbExclamation
        GoTo Cleanup
    End If

    ' 2) Get the PivotField by caption (as shown in the field list)
    Set pf = pt.PivotFields("Artikelnummer")

    ' 3) Get the Excel table with the desired Artikelnummer list
    Set wsList = FindTableSheet("tbl_Artikel")
    If wsList Is Nothing Then
        MsgBox "Table 'tbl_Artikel' was not found in this workbook.", vbExclamation
        GoTo Cleanup
    End If

    Set lo = wsList.ListObjects("tbl_Artikel")
    If lo.ListColumns.Count = 0 Then
        MsgBox "Table 'tbl_Artikel' has no columns.", vbExclamation
        GoTo Cleanup
    End If

    ' 4) Load Artikelnummer values into a dictionary for fast lookup
    Set dict = CreateObject("Scripting.Dictionary")
    dict.CompareMode = 1 ' TextCompare

    If lo.ListColumns("Artikelnummer").DataBodyRange Is Nothing Then
        MsgBox "Table 'tbl_Artikel[Artikelnummer]' is empty.", vbExclamation
        GoTo Cleanup
    End If

    For Each r In lo.ListColumns("Artikelnummer").DataBodyRange.Cells
        key = Trim(CStr(r.Value))
        If Len(key) > 0 Then dict(key) = True
    Next r

    If dict.Count = 0 Then
        MsgBox "Table 'tbl_Artikel[Artikelnummer]' contains no usable values.", vbExclamation
        GoTo Cleanup
    End If

    ' 5) Apply the filter
    pt.ManualUpdate = True

    ' Determine if this is an OLAP pivot (Power BI / Analysis Services)
    isOlap = False
    On Error Resume Next
    isOlap = pt.PivotCache.OLAP
    On Error GoTo ErrHandler

    pf.ClearAllFilters

    If isOlap Then
        ' OLAP: use VisibleItemsList (requires item unique names)
        cnt = 0
        For Each pi In pf.PivotItems
            If dict.Exists(Trim(CStr(pi.Caption))) Then
                cnt = cnt + 1
                ReDim Preserve arr(1 To cnt)
                arr(cnt) = pi.Name
            End If
        Next pi

        If cnt = 0 Then
            MsgBox "No matching Artikelnummer found in the PivotField. Check number format (text vs number).", vbExclamation
            GoTo CleanupPivot
        End If

        pf.VisibleItemsList = arr

    Else
        ' Non-OLAP: set PivotItems visibility directly
        ' Important: Excel does not allow hiding all items at once, so we keep one item visible first.
        Dim firstVisibleSet As Boolean
        firstVisibleSet = False

        ' First pass: hide items not in the list; keep at least one visible to avoid errors
        For Each pi In pf.PivotItems
            If dict.Exists(Trim(CStr(pi.Caption))) Then
                If Not firstVisibleSet Then
                    pi.Visible = True
                    firstVisibleSet = True
                End If
            Else
                On Error Resume Next
                pi.Visible = False
                On Error GoTo ErrHandler
            End If
        Next pi

        If Not firstVisibleSet Then
            MsgBox "No matching Artikelnummer found in the PivotField. Check number format (text vs number).", vbExclamation
            GoTo CleanupPivot
        End If

        ' Second pass: ensure all matching items are visible
        For Each pi In pf.PivotItems
            If dict.Exists(Trim(CStr(pi.Caption))) Then
                On Error Resume Next
                pi.Visible = True
                On Error GoTo ErrHandler
            End If
        Next pi
    End If

CleanupPivot:
    pt.ManualUpdate = False
    On Error Resume Next
    pt.RefreshTable
    On Error GoTo 0

    If cnt > 0 Then
        MsgBox "Filter applied: " & cnt & " Artikelnummer.", vbInformation
    Else
        MsgBox "Filter applied.", vbInformation
    End If

Cleanup:
    Application.ScreenUpdating = True
    Application.EnableEvents = True
    Application.Calculation = xlCalculationAutomatic
    Exit Sub

ErrHandler:
    ' Generic error handler
    MsgBox "Error " & Err.Number & ": " & Err.Description, vbExclamation
    Resume Cleanup
End Sub

Private Function GetPivotTableSafe() As PivotTable
    ' Tries to get PivotTable from ActiveCell; if not possible, returns the first PivotTable on ActiveSheet.
    Dim pt As PivotTable
    On Error Resume Next
    Set pt = ActiveCell.PivotTable
    On Error GoTo 0

    If Not pt Is Nothing Then
        Set GetPivotTableSafe = pt
        Exit Function
    End If

    If ActiveSheet.PivotTables.Count > 0 Then
        Set GetPivotTableSafe = ActiveSheet.PivotTables(1)
        Exit Function
    End If

    Set GetPivotTableSafe = Nothing
End Function

Private Function FindTableSheet(ByVal tableName As String) As Worksheet
    ' Finds the worksheet that contains a given ListObject (Excel table).
    Dim ws As Worksheet
    For Each ws In ActiveWorkbook.Worksheets
        On Error Resume Next
        If ws.ListObjects(tableName).Name = tableName Then
            Set FindTableSheet = ws
            Exit Function
        End If
        On Error GoTo 0
    Next ws
    Set FindTableSheet = Nothing
End Function
