// 1) Временный флаг: безалкогольный ли Produktname
#"IsNA hinzugefügt" =
    Table.AddColumn(
        #"Erweiterte tbl_Drotax1",
        "IsNA",
        each
            let
                pn = Text.Lower(Text.From([Produktname]))
            in
                Text.Contains(pn, "alkoholfrei")
                or Text.Contains(pn, "0,0")
                or Text.Contains(pn, "0.0"),
        type logical
    ),

// 2) Применяем правила только для Kategorie = "BIE" внутри каждого Row_ID
#"BIE Alk-Regeln angewendet" =
    Table.Combine(
        Table.TransformRows(
            Table.Group(#"IsNA hinzugefügt", {"Row_ID"}, {{"t", each _, type table}}),
            (r) =>
                let
                    t = r[t],

                    // считаем, что эти поля константны внутри Row_ID (они из Wechsler)
                    kat = try Text.From(t[Kategorie]{0}) otherwise null,
                    af  = try Text.From(t[AlkFlag]{0}) otherwise null,
                    sl  = try Number.From(t[Slash]{0}) otherwise null,

                    res =
                        if kat <> "BIE" then
                            t
                        else if af = "AF-" then
                            Table.SelectRows(t, each [IsNA] <> true)
                        else if af = "AF+" and sl = 0 then
                            Table.SelectRows(t, each [IsNA] = true)
                        else
                            t
                in
                    res
        )
    ),

// 3) Убираем временную колонку
#"IsNA entfernt" =
    Table.RemoveColumns(#"BIE Alk-Regeln angewendet", {"IsNA"})
