Option Explicit

Public Sub Slicer_Info()
    ' Prints slicer technical names to the Immediate Window (Ctrl+G).
    ' Also shows a small message with the first match for Artikelnummer.

    Dim sc As SlicerCache
    Dim sl As Slicer

    Debug.Print "---- SLICER CACHES ----"
    For Each sc In ActiveWorkbook.SlicerCaches
        Debug.Print "SlicerCache.Name = " & sc.Name & " | SourceName = " & sc.SourceName
        For Each sl In sc.Slicers
            Debug.Print "   Slicer.Name = " & sl.Name & " | Caption = " & sl.Caption
        Next sl
    Next sc

    MsgBox "Slicer info printed to Immediate Window (Ctrl+G).", vbInformation
End Sub


Public Sub Slicer_Filter_Artikelnummer_FromTable()
    ' Filters an OLAP slicer by matching slicer item captions to values in tbl_Artikel[Artikelnummer].
    ' No need to know technical slicer names; it searches by SourceName containing "Artikelnummer".

    Dim stepName As String
    Dim lo As ListObject
    Dim rng As Range
    Dim dict As Object
    Dim sc As SlicerCache
    Dim si As SlicerItem
    Dim names() As String
    Dim cnt As Long
    Dim k As Variant

    On Error GoTo ErrHandler

    ' 1) Get the table and column with the desired Artikelnummer list
    stepName = "Get tbl_Artikel and column Artikelnummer"
    Set lo = ActiveWorkbook.ListObjects("tbl_Artikel")
    Set rng = lo.ListColumns("Artikelnummer").DataBodyRange

    Set dict = CreateObject("Scripting.Dictionary")
    dict.CompareMode = 1 ' TextCompare

    ' 2) Load desired values into a dictionary (as strings)
    stepName = "Load Artikelnummer list into dictionary"
    Dim c As Range, v As String
    For Each c In rng.Cells
        v = Trim$(CStr(c.Value))
        If Len(v) > 0 Then
            dict(v) = True
        End If
    Next c

    If dict.Count = 0 Then
        MsgBox "tbl_Artikel[Artikelnummer] is empty.", vbExclamation
        Exit Sub
    End If

    ' 3) Find the OLAP slicer cache for Artikelnummer
    stepName = "Find SlicerCache for Artikelnummer"
    Set sc = Nothing

    For Each sc In ActiveWorkbook.SlicerCaches
        ' SourceName for OLAP often contains something like: [Artikel].[Artikelnummer]
        If InStr(1, sc.SourceName, "Artikelnummer", vbTextCompare) > 0 Then
            Exit For
        End If
    Next

    If sc Is Nothing Then
        MsgBox "No SlicerCache found where SourceName contains 'Artikelnummer'. Run Slicer_Info first.", vbExclamation
        Exit Sub
    End If

    ' 4) Collect OLAP unique names of slicer items whose Caption matches our list
    stepName = "Collect matching slicer item unique names"
    cnt = 0
    ReDim names(1 To dict.Count)

    For Each si In sc.SlicerItems
        ' si.Caption is what you see in the slicer buttons (e.g., 1349)
        If dict.Exists(Trim$(CStr(si.Caption))) Then
            cnt = cnt + 1
            names(cnt) = si.Name ' For OLAP, this is the unique member name
        End If
    Next si

    If cnt = 0 Then
        MsgBox "No matches found between tbl_Artikel[Artikelnummer] and slicer items." & vbCrLf & _
               "Possible reason: different formatting (text vs number) or different codes in the cube.", vbExclamation
        Exit Sub
    End If

    ReDim Preserve names(1 To cnt)

    ' 5) Apply the filter using VisibleSlicerItemsList (OLAP-safe way)
    stepName = "Apply VisibleSlicerItemsList"
    sc.ClearManualFilter
    sc.VisibleSlicerItemsList = names

    MsgBox "OK. Selected " & cnt & " Artikelnummer in slicer.", vbInformation
    Exit Sub

ErrHandler:
    MsgBox "Failed at step: " & stepName & vbCrLf & _
           "Error " & Err.Number & ": " & Err.Description, vbExclamation
End Sub
