Option Explicit

Public Sub Wechsler_PullLatest_Attachments_Overwrite_RefreshPQ()
    ' ===== SETTINGS =====
    Dim subjectPhrase As String
    subjectPhrase = "Wechsler KW"          ' Phrase to search in email subject

    ' Choose a stable folder where you have write permissions.
    ' Recommended: user profile, not C:\ root.
    Dim targetFolder As String
    targetFolder = Environ$("USERPROFILE") & "\Documents\Wechsler\InboxDrop"
    ' If you insist on H:\, make sure H: is mapped and you have permissions:
    ' targetFolder = "H:\Wechsler\InboxDrop"

    ' If empty -> refresh all queries/connections in this workbook.
    ' Otherwise specify a particular query name (as shown in Queries & Connections).
    Dim pqQueryName As String
    pqQueryName = ""

    ' ===== 1) Find the latest email =====
    Dim mail As Object
    Set mail = GetLatestMailBySubjectPhrase(subjectPhrase)

    If mail Is Nothing Then
        MsgBox "No email found with subject containing: " & subjectPhrase, vbExclamation
        Exit Sub
    End If

    Debug.Print "FOUND: " & mail.ReceivedTime & " | " & mail.Subject

    ' ===== 2) Ensure folder exists (recursive) =====
    EnsureFolderExistsRecursive targetFolder
    Debug.Print "TARGET FOLDER: " & targetFolder

    ' ===== 3) Save attachments using their original names (overwrite if exists) =====
    Dim savedCount As Long
    savedCount = SaveAllAttachments_Overwrite(mail, targetFolder)

    Debug.Print "Saved files: " & savedCount

    ' ===== 4) Refresh Power Query =====
    RefreshPowerQuery pqQueryName

    MsgBox "Done. Saved attachments: " & savedCount & vbCrLf & _
           "Folder: " & targetFolder, vbInformation
End Sub


' --- Finds the newest email in Inbox whose Subject contains the given phrase ---
Private Function GetLatestMailBySubjectPhrase(ByVal subjectPhrase As String) As Object
    Dim olApp As Object, ns As Object, inbox As Object, items As Object
    Set olApp = CreateObject("Outlook.Application")
    Set ns = olApp.GetNamespace("MAPI")
    Set inbox = ns.GetDefaultFolder(6) ' 6 = Inbox
    Set items = inbox.Items

    items.Sort "[ReceivedTime]", True ' newest first

    Dim i As Long
    For i = 1 To items.Count
        If TypeName(items(i)) = "MailItem" Then
            Dim mail As Object
            Set mail = items(i)
            If InStr(1, mail.Subject, subjectPhrase, vbTextCompare) > 0 Then
                Set GetLatestMailBySubjectPhrase = mail
                Exit Function
            End If
        End If
    Next i

    Set GetLatestMailBySubjectPhrase = Nothing
End Function


' --- Saves ALL attachments into folderPath using original filenames.
'     If the file already exists -> delete it first (true overwrite).
Private Function SaveAllAttachments_Overwrite(ByVal mail As Object, ByVal folderPath As String) As Long
    Dim att As Object, cnt As Long
    cnt = 0

    If mail.Attachments.Count = 0 Then
        SaveAllAttachments_Overwrite = 0
        Exit Function
    End If

    For Each att In mail.Attachments
        Dim fileName As String, fullPath As String
        fileName = CleanFileName(CStr(att.FileName))
        fullPath = folderPath & "\" & fileName

        ' Overwrite behavior: delete old file if present
        If Dir(fullPath) <> vbNullString Then
            Kill fullPath
        End If

        att.SaveAsFile fullPath
        cnt = cnt + 1

        Debug.Print "Saved: " & fullPath
    Next att

    SaveAllAttachments_Overwrite = cnt
End Function


' --- Creates a full folder path recursively (MkDir cannot create nested folders in one call) ---
Private Sub EnsureFolderExistsRecursive(ByVal folderPath As String)
    On Error GoTo EH

    If Len(folderPath) = 0 Then Exit Sub
    If Dir(folderPath, vbDirectory) <> vbNullString Then Exit Sub

    Dim parentPath As String
    parentPath = Left$(folderPath, InStrRev(folderPath, "\") - 1)

    ' Create parent first
    If Len(parentPath) > 0 And Dir(parentPath, vbDirectory) = vbNullString Then
        EnsureFolderExistsRecursive parentPath
    End If

    ' Now create this folder
    MkDir folderPath
    Exit Sub

EH:
    ' Provide a clear error message with the failing path
    MsgBox "Failed to create folder:" & vbCrLf & folderPath & vbCrLf & _
           "Error " & Err.Number & ": " & Err.Description, vbCritical
    Err.Clear
End Sub


' --- Replaces characters that are invalid in Windows filenames ---
Private Function CleanFileName(ByVal s As String) As String
    Dim bad As Variant, ch As Variant
    bad = Array("\", "/", ":", "*", "?", """", "<", ">", "|")
    For Each ch In bad
        s = Replace(s, ch, "_")
    Next ch
    CleanFileName = s
End Function


' --- Refreshes Power Query: either a specific query or the whole workbook ---
Private Sub RefreshPowerQuery(ByVal pqQueryName As String)
    If Len(Trim$(pqQueryName)) = 0 Then
        ThisWorkbook.RefreshAll
        Exit Sub
    End If

    On Error GoTo fallback
    ThisWorkbook.Queries(pqQueryName).Refresh
    Exit Sub

fallback:
    ThisWorkbook.RefreshAll
End Sub
