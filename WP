Option Explicit

Public Sub FilterPivot_Artikelnummer_FromTable()
    ' Filters the first RowField of the active PivotTable using values from tbl_Artikel[Artikelnummer].
    ' This avoids PivotFields("...") name issues (common with external/OLAP pivots).

    Dim pt As PivotTable
    Dim pf As PivotField
    Dim wsList As Worksheet
    Dim lo As ListObject
    Dim dict As Object
    Dim r As Range
    Dim key As String

    Dim pi As PivotItem
    Dim arr() As Variant
    Dim cnt As Long
    Dim isOlap As Boolean

    On Error GoTo ErrHandler

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual

    ' Get PivotTable safely
    Set pt = GetPivotTableSafe()
    If pt Is Nothing Then
        MsgBox "No PivotTable found. Click inside the PivotTable and run the macro again.", vbExclamation
        GoTo Cleanup
    End If

    ' Use the first RowField (your Artikelnummer field)
    If pt.RowFields.Count = 0 Then
        MsgBox "The PivotTable has no RowFields. Put Artikelnummer into Rows and try again.", vbExclamation
        GoTo Cleanup
    End If
    Set pf = pt.RowFields(1)

    ' Get the list table
    Set wsList = FindTableSheet("tbl_Artikel")
    If wsList Is Nothing Then
        MsgBox "Table 'tbl_Artikel' was not found in this workbook.", vbExclamation
        GoTo Cleanup
    End If
    Set lo = wsList.ListObjects("tbl_Artikel")

    ' Load list values into dictionary (normalize to text without spaces)
    Set dict = CreateObject("Scripting.Dictionary")
    dict.CompareMode = 1 ' TextCompare

    If lo.ListColumns("Artikelnummer").DataBodyRange Is Nothing Then
        MsgBox "Table 'tbl_Artikel[Artikelnummer]' is empty.", vbExclamation
        GoTo Cleanup
    End If

    For Each r In lo.ListColumns("Artikelnummer").DataBodyRange.Cells
        key = NormalizeKey(r.Value)
        If Len(key) > 0 Then dict(key) = True
    Next r

    If dict.Count = 0 Then
        MsgBox "Table 'tbl_Artikel[Artikelnummer]' contains no usable values.", vbExclamation
        GoTo Cleanup
    End If

    ' Detect OLAP
    isOlap = False
    On Error Resume Next
    isOlap = pt.PivotCache.OLAP
    On Error GoTo ErrHandler

    pt.ManualUpdate = True
    pf.ClearAllFilters

    If isOlap Then
        ' OLAP: use VisibleItemsList with item names
        cnt = 0
        For Each pi In pf.PivotItems
            If dict.Exists(NormalizeKey(pi.Caption)) Then
                cnt = cnt + 1
                ReDim Preserve arr(1 To cnt)
                arr(cnt) = pi.Name
            End If
        Next pi

        If cnt = 0 Then
            MsgBox "No matching items found. Check number formatting (text vs number) and leading zeros.", vbExclamation
            GoTo CleanupPivot
        End If

        pf.VisibleItemsList = arr
        MsgBox "Filter applied (OLAP): " & cnt & " items.", vbInformation

    Else
        ' Non-OLAP: toggle PivotItems visibility
        Dim firstVisibleSet As Boolean
        firstVisibleSet = False

        For Each pi In pf.PivotItems
            If dict.Exists(NormalizeKey(pi.Caption)) Then
                If Not firstVisibleSet Then
                    pi.Visible = True
                    firstVisibleSet = True
                End If
            Else
                On Error Resume Next
                pi.Visible = False
                On Error GoTo ErrHandler
            End If
        Next pi

        If Not firstVisibleSet Then
            MsgBox "No matching items found. Check number formatting (text vs number) and leading zeros.", vbExclamation
            GoTo CleanupPivot
        End If

        For Each pi In pf.PivotItems
            If dict.Exists(NormalizeKey(pi.Caption)) Then
                On Error Resume Next
                pi.Visible = True
                On Error GoTo ErrHandler
            End If
        Next pi

        MsgBox "Filter applied (non-OLAP).", vbInformation
    End If

CleanupPivot:
    pt.ManualUpdate = False
    On Error Resume Next
    pt.RefreshTable
    On Error GoTo 0

Cleanup:
    Application.ScreenUpdating = True
    Application.EnableEvents = True
    Application.Calculation = xlCalculationAutomatic
    Exit Sub

ErrHandler:
    MsgBox "Error " & Err.Number & ": " & Err.Description, vbExclamation
    Resume Cleanup
End Sub

Private Function NormalizeKey(ByVal v As Variant) As String
    ' Normalizes keys to improve matching across text/number formats.
    ' - trims spaces
    ' - converts numbers to integer-like text if possible
    Dim s As String
    s = Trim(CStr(v))

    ' If it looks numeric, remove decimal part like "1349.0"
    If Len(s) > 0 And IsNumeric(s) Then
        ' Use CLng to remove .0, but keep large ids as text
        On Error Resume Next
        s = CStr(CLng(CDbl(s)))
        On Error GoTo 0
    End If

    NormalizeKey = s
End Function

Private Function GetPivotTableSafe() As PivotTable
    Dim pt As PivotTable
    On Error Resume Next
    Set pt = ActiveCell.PivotTable
    On Error GoTo 0

    If Not pt Is Nothing Then
        Set GetPivotTableSafe = pt
        Exit Function
    End If

    If ActiveSheet.PivotTables.Count > 0 Then
        Set GetPivotTableSafe = ActiveSheet.PivotTables(1)
        Exit Function
    End If

    Set GetPivotTableSafe = Nothing
End Function

Private Function FindTableSheet(ByVal tableName As String) As Worksheet
    Dim ws As Worksheet
    For Each ws In ActiveWorkbook.Worksheets
        On Error Resume Next
        If ws.ListObjects(tableName).Name = tableName Then
            Set FindTableSheet = ws
            Exit Function
        End If
        On Error GoTo 0
    Next ws
    Set FindTableSheet = Nothing
End Function
