Option Explicit

'========================
' USER SETTINGS (adjust if needed)
'========================
Private Const LIST_TABLE_NAME As String = "tbl_Artikel"
Private Const LIST_COLUMN_NAME As String = "Artikelnummer"
' The slicer cache name will be detected automatically.
'========================


'------------------------
' STEP A: Run this once after you manually created the slicer for Artikelnummer.
' It will detect the slicer cache and show its name (so we know VBA sees it).
'------------------------
Public Sub DetectArtikelnummerSlicer()
    Dim pt As PivotTable
    Dim sc As SlicerCache
    Dim msg As String

    Set pt = GetPivotTableSafe()
    If pt Is Nothing Then
        MsgBox "No PivotTable found. Click any cell inside the PivotTable and run again.", vbExclamation
        Exit Sub
    End If

    Set sc = FindSlicerCacheForPivotField(pt, "Artikelnummer")
    If sc Is Nothing Then
        MsgBox "Could not find a slicer for field 'Artikelnummer'." & vbCrLf & _
               "Please create a slicer (Datenschnitt) for Artikelnummer first, then run again.", vbExclamation
        Exit Sub
    End If

    msg = "Slicer cache found:" & vbCrLf & _
          "Name: " & sc.Name & vbCrLf & _
          "SourceName: " & sc.SourceName
    MsgBox msg, vbInformation
End Sub


'------------------------
' STEP B: Main macro
' Reads Artikelnummer list from tbl_Artikel[Artikelnummer]
' and applies the filter via the slicer (works with OLAP pivots).
'------------------------
Public Sub ApplyArtikelnummerFilter_FromTable_UsingSlicer()
    Dim pt As PivotTable
    Dim sc As SlicerCache
    Dim lo As ListObject
    Dim dict As Object
    Dim c As Range
    Dim cap As String

    Dim selNames() As String
    Dim n As Long

    Application.ScreenUpdating = False
    Application.EnableEvents = False

    On Error GoTo CleanFail

    Set pt = GetPivotTableSafe()
    If pt Is Nothing Then
        MsgBox "No PivotTable found. Click any cell inside the PivotTable and run again.", vbExclamation
        GoTo CleanExit
    End If

    ' Find the slicer cache connected to Artikelnummer
    Set sc = FindSlicerCacheForPivotField(pt, "Artikelnummer")
    If sc Is Nothing Then
        MsgBox "Slicer for 'Artikelnummer' not found. Create the slicer first, then run again.", vbExclamation
        GoTo CleanExit
    End If

    ' Get the list table and build a dictionary of desired Artikelnummer values (as text)
    Set lo = FindListObjectAnywhere(LIST_TABLE_NAME)
    If lo Is Nothing Then
        MsgBox "Table '" & LIST_TABLE_NAME & "' not found.", vbExclamation
        GoTo CleanExit
    End If

    If lo.ListColumns.Count = 0 Then
        MsgBox "Table '" & LIST_TABLE_NAME & "' has no columns.", vbExclamation
        GoTo CleanExit
    End If

    If Not HasListColumn(lo, LIST_COLUMN_NAME) Then
        MsgBox "Column '" & LIST_COLUMN_NAME & "' not found in table '" & LIST_TABLE_NAME & "'.", vbExclamation
        GoTo CleanExit
    End If

    Set dict = CreateObject("Scripting.Dictionary")
    dict.CompareMode = 1 ' TextCompare

    For Each c In lo.ListColumns(LIST_COLUMN_NAME).DataBodyRange.Cells
        cap = Trim$(CStr(c.Value))
        If Len(cap) > 0 Then
            If Not dict.Exists(cap) Then dict.Add cap, True
        End If
    Next c

    If dict.Count = 0 Then
        MsgBox "No Artikelnummer values found in '" & LIST_TABLE_NAME & "[" & LIST_COLUMN_NAME & "]'.", vbExclamation
        GoTo CleanExit
    End If

    ' Map captions -> slicer item unique names (OLAP needs item .Name, not caption)
    n = 0
    Dim si As SlicerItem
    For Each si In sc.SlicerItems
        If si.HasData Then
            If dict.Exists(Trim$(CStr(si.Caption))) Then
                n = n + 1
                ReDim Preserve selNames(1 To n)
                selNames(n) = si.Name
            End If
        End If
    Next si

    If n = 0 Then
        MsgBox "None of the Artikelnummer values from your table were found in the slicer items." & vbCrLf & _
               "Possible reasons:" & vbCrLf & _
               "- Different formatting (e.g., leading zeros)" & vbCrLf & _
               "- Artikelnummer in OLAP is not the same level you used" & vbCrLf & _
               "- Your list contains values not present in the current cube scope", vbExclamation
        GoTo CleanExit
    End If

    ' Apply selection
    sc.ClearManualFilter
    sc.VisibleSlicerItemsList = selNames

    MsgBox "Filter applied via slicer." & vbCrLf & _
           "Selected items: " & n, vbInformation

CleanExit:
    Application.ScreenUpdating = True
    Application.EnableEvents = True
    Exit Sub

CleanFail:
    MsgBox "Error " & Err.Number & ": " & Err.Description, vbExclamation
    Resume CleanExit
End Sub


'========================
' Helpers
'========================

' Returns PivotTable of the active cell (preferred). If not inside a pivot, tries first pivot on active sheet.
Private Function GetPivotTableSafe() As PivotTable
    On Error Resume Next
    If Not ActiveCell Is Nothing Then
        Set GetPivotTableSafe = ActiveCell.PivotTable
        If Not GetPivotTableSafe Is Nothing Then Exit Function
    End If
    On Error GoTo 0

    Dim ws As Worksheet
    Set ws = ActiveSheet
    If ws.PivotTables.Count > 0 Then
        Set GetPivotTableSafe = ws.PivotTables(1)
    End If
End Function

' Finds a slicer cache connected to the pivot and matching the field caption/name.
Private Function FindSlicerCacheForPivotField(ByVal pt As PivotTable, ByVal fieldToken As String) As SlicerCache
    Dim sc As SlicerCache
    Dim token As String
    token = LCase$(fieldToken)

    ' Look through slicer caches and check:
    ' - It is connected to our pivot
    ' - Its SourceName contains the token (works for OLAP: e.g. [Artikel].[Artikelnummer]...)
    For Each sc In ActiveWorkbook.SlicerCaches
        If IsSlicerConnectedToPivot(sc, pt) Then
            If InStr(1, LCase$(sc.SourceName), token, vbTextCompare) > 0 Then
                Set FindSlicerCacheForPivotField = sc
                Exit Function
            End If
        End If
    Next sc
End Function

Private Function IsSlicerConnectedToPivot(ByVal sc As SlicerCache, ByVal pt As PivotTable) As Boolean
    On Error Resume Next
    Dim p As PivotTable
    For Each p In sc.PivotTables
        If p.Name = pt.Name And p.Parent.Name = pt.Parent.Name Then
            IsSlicerConnectedToPivot = True
            Exit Function
        End If
    Next p
    On Error GoTo 0
End Function

Private Function FindListObjectAnywhere(ByVal loName As String) As ListObject
    Dim ws As Worksheet
    Dim lo As ListObject
    For Each ws In ActiveWorkbook.Worksheets
        For Each lo In ws.ListObjects
            If StrComp(lo.Name, loName, vbTextCompare) = 0 Then
                Set FindListObjectAnywhere = lo
                Exit Function
            End If
        Next lo
    Next ws
End Function

Private Function HasListColumn(ByVal lo As ListObject, ByVal colName As String) As Boolean
    Dim lc As ListColumn
    For Each lc In lo.ListColumns
        If StrComp(lc.Name, colName, vbTextCompare) = 0 Then
            HasListColumn = True
            Exit Function
        End If
    Next lc
End Function
