Sub Prepare_Drohtax_File()

    Dim wb As Workbook
    Dim wsActive As Worksheet
    Dim wsFilter As Worksheet
    Dim weekText As String
    Dim weekNum As Long
    Dim fileName As String
    Dim desktopPath As String
    
    Set wb = ThisWorkbook
    Set wsActive = ActiveSheet
    
    ' Get week number from sheet "FilterDetails", cell C2 (e.g. "49/2025")
    Set wsFilter = wb.Worksheets("FilterDetails")
    weekText = CStr(wsFilter.Range("C2").Value)
    
    ' Take first two characters and add 2
    weekNum = CLng(Left(weekText, 2)) + 2
    
    ' Build file name: Drohtax-Preise_KWXX_2025.xlsx
    fileName = "Drohtax-Preise_KW" & Format(weekNum, "00") & "_2025.xlsx"
    
    ' Path to Desktop
    desktopPath = Environ("USERPROFILE") & "\Desktop\"
    
    ' Save workbook to Desktop with new name
    Application.DisplayAlerts = False         ' avoid overwrite warnings
    wb.SaveAs Filename:=desktopPath & fileName, _
              FileFormat:=xlOpenXMLWorkbook   ' .xlsx
    Application.DisplayAlerts = True
    
    ' Rename active sheet to "Getränke"
    wsActive.Name = "Getränke"
    
    With wsActive
        ' 1) Delete first three rows
        .Rows("1:3").Delete Shift:=xlUp
        
        ' 2) Keep only columns C, F, J, AG, AH, AT, BM (delete all others up to BO)
        Dim keepCols As Variant
        Dim lastCol As Long
        Dim col As Long
        Dim i As Long
        Dim keep As Boolean
        
        ' List of columns to keep
        keepCols = Array("C", "F", "J", "AG", "AH", "AT", "BM")
        
        ' Last column of the table is BO
        lastCol = .Range("BO1").Column
        
        ' Loop from right to left and delete all columns that are not in keepCols
        For col = lastCol To 1 Step -1
            keep = False
            For i = LBound(keepCols) To UBound(keepCols)
                If col = .Range(keepCols(i) & "1").Column Then
                    keep = True
                    Exit For
                End If
            Next i
            
            If Not keep Then
                .Columns(col).Delete
            End If
        Next col
    End With
    
End Sub
